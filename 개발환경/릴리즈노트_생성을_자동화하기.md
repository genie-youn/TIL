# leran-chagelog로 릴리즈노트 생성을 자동화하기

현재는 JIRA의 릴리즈노트를 긁어서 템플릿에 맞춰 넣은뒤 이슈의 카테고리가 적절치 않은 경우 적절히 맞는 카테고리로 옮겨주고 뺄건빼고 전과정 최첨산 수동으로 하고 있었다.
이걸 자동화할까 말까 고민이 많았었는데, 수작업이 얼마 안걸리기도 하고 사실 가장 정확한 방법인지라 내가 앞으로 수작업으로 이걸 작성하는 시간의 총합이 자동화하는데 들이는 시간의 총합보다 많다고 생각해 계속 미루고 있었다.

그렇게 돌이켜보니 어느새 3년이란 시간이 흘렀고 진작 자동화했으면 지금쯤 손익분기를 넘었겠다는 생각이 들었을때 [leran-chagelog](https://github.com/lerna/lerna-changelog)를 알게되었다.

이 친구가 나에게 광명을 선사하리라.

### 검토
leran-chagelog는 PR을 기반으로 chagelog를 생성해주는 도구이다. lerna의 하위프로젝트인만큼 당연히 모노레포도 지원한다.
GithubAPI를 통해 interaction하는 부분이 있기때문에 사내 Enterprise github에서 사용해도 괜찮을지 확인하기위해 어떻게 구현되어 있는지 확인해보았다.

#### 실행
bin/cli.js 로 제공됨.
실행하면 cli.run() 호출.

Configuration 을 load
- git root path를 읽어온 다음
- 해당 path로부터 config 생성 시작
  - package.json 에서 선언되어 있다면 그걸 가져오고
  - 없다면 lerna.json을 찾아보고
  - 없다면 빈 config 생성
  - 커맨드라인으로 전달받은 repo 파라미터의 값이 있다면 이 값으로 config.repo 엎어침
  - config.repo가 존재하지 않으면
    - package.json에 repository.url 혹은 repository 값과
    - hosted-git-info 라이브러리를 사용해 github의 repo일 경우에만
    - `${info.user}/${info.project} 형태로 생성
  - next-version-from-metadata 가 존재하면 package.json이나 lerna.json의 version을 
    - config.nextVersion 으로 지정
  - 따로 지정된 라벨이 없다면 기본 라벨을 사용하고
  - 무시할 커밋 패턴이 없다면 기본 커밋 무시 패턴을 사용하고
  - 생성된 config 객체를 반환
- 생성된 config의 다음버전이 파라미터로 주어진 다음버전과 상이하다면
- 파라미터로 주어진 다음 버전으로 엎어침

생성된 Configuration을 가지고 Chagelog 객체 생성
- GithubAPI 객체 생성
  - rootPath/cacheDir/github 디렉터리를 생성해서 cacheDir로 사용
- MarkdownRenderer 객체 생성
  - renderer는 categories에 config에 설정해두었던 값들과
  - GithubAPI 객체를 통해 baseIssueUrl 을 가져온뒤 (`https://github.com/${repo}/issues/`)
  - unreleasedName 에 다음버전을 설정 (없을 시 Unreleased)

생성된 Chagelog에게 createMarkdown 메세지 호출
- argv["from"] 이 존재하지 않으면 lastTag로 from 설정
- argv["to"] 이 존재하지 않으면 HEAD로 to 설정
- from부터 to까지 릴리즈리스트 생성
  - from부터 to까지 커밋정보 조회
    -  from부터 to까지 커밋리스트 조회
      - Git 모듈에 커밋 리스트 요청
        - execa 로 git 커맨드 실행한뒤 파싱해서 CommitListItem의 배열로 만들어 반환
    - 커밋 리스트 가지고 커밋 인포로 변환
      - sha, refName, summary: message, date 를 추출해서
      - 할당된 태그가 있는지 찾고
      - message를 가지고 pullrequestId를 조회하고
        - find-pull-request-id 모듈에 findPullRequestId 호출
          - 메세지를 잘라서
          - 첫번째 라인에서
          - 머지커밋인 /^Merge pull request #(\d+) from / 에 해당하는게 있나 찾고 있으면 반환
          - 없으면 스쿼시커밋인 /\(#(\d+)\)$/ 에 해당하는게 있나 찾고 있으면 반환
          - 없으면 homu? 인 /^Auto merge of #(\d+) - / 에 해당하는게 있나 찾고 있으면 반환
          - 없으면 null
      - CommitInfo 인스턴스화해서 반환
    - CommitInfo 를 가지고 이슈 데이터 다운로드
      - progressBar 의 init call
        - bar가 존재하면 종료
        - 3rd party 라이브러리인 progress 객체 생성후 bar에 할당
      - pMap call
